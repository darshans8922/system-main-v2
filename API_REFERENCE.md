# API Reference

Quick reference for all APIs in the Code Broadcasting System.

**Base URL:**
- Local: `http://localhost:5000`
- Production: `https://system-main-v2.onrender.com`

---

## HTTP REST APIs

### 1. Send Code (POST/GET)
**Endpoint:** `POST /api/ingest` or `GET /api/ingest`

**Request (POST):**
```bash
curl -X POST http://localhost:5000/api/ingest \
  -H "Content-Type: application/json" \
  -d '{
    "username": "bharat",
    "code": "ABC123",
    "source": "my-app",
    "type": "default",
    "metadata": {"note": "test"}
  }'
```

**Request (GET):**
```bash
curl "http://localhost:5000/api/ingest?username=bharat&code=ABC123&source=my-app"
```

**Response:**
```json
{
  "status": "success",
  "message": "Code received and broadcasted",
  "username": "bharat"
}
```

**Required Fields:**
- `username` - Must exist in database
- `code` - The code to broadcast

**Optional Fields:**
- `source` - Source identifier
- `type` - Code type (default: "default")
- `metadata` - Additional data (object)

---

### 2. Verify Username
**Endpoint:** `GET /api/users/<username>/verify`

**Request:**
```bash
curl http://localhost:5000/api/users/bharat/verify
```

**Response (200 - User exists):**
```json
{
  "username": "bharat",
  "user_id": 1,
  "verified": true,
  "cache_expires_at": 1732030000
}
```

**Response (404 - User not found):**
```json
{
  "username": "invalid",
  "verified": false
}
```

---

### 3. Health Check
**Endpoint:** `GET /health`

**Request:**
```bash
curl http://localhost:5000/health
```

**Response:**
```json
{
  "status": "healthy",
  "service": "code-server"
}
```

---

## WebSocket APIs (Socket.IO)

### Connection URLs
- Default: `ws://localhost:5000/`
- Internal: `ws://localhost:5000/internal/newcodes`
- WebSocket Ingest: `ws://localhost:5000/ws/ingest`
- Embed: `ws://localhost:5000/embed`

### 1. Connect to Default Namespace
**Connection:**
```javascript
const socket = io('http://localhost:5000', {
  query: { username: 'bharat' }
});

socket.on('connect', () => {
  console.log('Connected');
});

socket.on('new_code', (data) => {
  console.log('New code:', data);
});
```

**Send Code:**
```javascript
socket.emit('code', {
  code: 'ABC123',
  source: 'my-app',
  type: 'default',
  metadata: { note: 'test' }
});
```

---

### 2. Connect to Internal Namespace
**Connection:**
```javascript
const socket = io('http://localhost:5000/internal/newcodes', {
  query: { username: 'bharat' }
});

socket.on('connected', () => {
  console.log('Connected to internal endpoint');
});

socket.on('new_code', (data) => {
  console.log('New code:', data);
});
```

**Send Code:**
```javascript
socket.emit('code', {
  code: 'ABC123',
  source: 'internal',
  type: 'default'
});
```

---

## SSE (Server-Sent Events) APIs

### 1. Get Embed Stream Token
**Endpoint:** `GET /embed-stream?user=<username>&nonce=<nonce>`

**Request:**
```bash
curl "http://localhost:5000/embed-stream?user=bharat&nonce=abc123"
```

**Response:** Returns HTML page with embedded SSE client

**Usage in Browser:**
```html
<iframe src="http://localhost:5000/embed-stream?user=bharat&nonce=abc123" style="display:none;"></iframe>

<script>
  window.addEventListener('message', (event) => {
    if (event.data.type === 'iframe_sse_message') {
      console.log('Code received:', event.data.data);
    }
  });
</script>
```

**PostMessage Events:**
- `iframe_ready` - Iframe loaded
- `iframe_sse_connected` - SSE connected
- `iframe_sse_message` - New code received
- `iframe_pong_success` - Heartbeat response
- `iframe_sse_error` - Connection error
- `iframe_sse_failed` - Connection failed

---

### 2. SSE Stream Endpoint
**Endpoint:** `GET /events?user=<username>&token=<token>`

**Note:** Token is generated by `/embed-stream` endpoint. Use the iframe method above for easier integration.

**Request:**
```bash
curl -N "http://localhost:5000/events?user=bharat&token=TOKEN_HERE"
```

**Response (Stream):**
```
data: {"type":"connected","message":"SSE stream connected","username":"bharat"}

data: {"code":"ABC123","username":"bharat","value":3,"timestamp":1732030000}
```

---

### 3. SSE Pong (Heartbeat)
**Endpoint:** `POST /sse-pong`

**Request:**
```bash
curl -X POST http://localhost:5000/sse-pong \
  -H "Content-Type: application/json" \
  -d '{"user": "bharat", "connection_id": "bharat_1732030000"}'
```

**Response:**
```json
{
  "status": "ok",
  "message": "Pong received"
}
```

---

## Code Payload Structure

All code broadcasts include:

```json
{
  "code": "ABC123",
  "username": "bharat",
  "user_id": 1,
  "source": "my-app",
  "type": "default",
  "timestamp": 1732030000,
  "value": 3,
  "metadata": {
    "note": "test",
    "ingested_via": "api"
  }
}
```

**Fields:**
- `code` - The code string (required)
- `username` - Username (auto-added by server)
- `user_id` - User ID (auto-added by server)
- `source` - Source identifier (optional)
- `type` - Code type, default: "default" (optional)
- `timestamp` - Unix timestamp (auto-added by server)
- `value` - Always `3` for SSE clients (auto-added)
- `metadata` - Additional data object (optional)

---

## Testing

### Create Test User
```bash
python test_sse_helper.py create bharat
```

### Send Test Code
```bash
python test_sse_helper.py send bharat TEST-123
```

### Test Pages
- Socket.IO Test: `http://localhost:5000/test`
- SSE Test: `http://localhost:5000/sse-test`

---

## Error Codes

- `400` - Bad Request (missing/invalid parameters)
- `401` - Unauthorized (invalid token)
- `403` - Forbidden (unknown username)
- `404` - Not Found (user not found)
- `500` - Server Error

---

## Quick Examples

### Python
```python
import requests

# Send code
response = requests.post('http://localhost:5000/api/ingest', json={
    'username': 'bharat',
    'code': 'ABC123',
    'source': 'python-script'
})
print(response.json())

# Verify user
response = requests.get('http://localhost:5000/api/users/bharat/verify')
print(response.json())
```

### JavaScript (Fetch)
```javascript
// Send code
fetch('http://localhost:5000/api/ingest', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    username: 'bharat',
    code: 'ABC123',
    source: 'web-app'
  })
})
.then(r => r.json())
.then(console.log);
```

### cURL
```bash
# Send code
curl -X POST http://localhost:5000/api/ingest \
  -H "Content-Type: application/json" \
  -d '{"username":"bharat","code":"ABC123","source":"curl"}'

# Verify user
curl http://localhost:5000/api/users/bharat/verify
```

